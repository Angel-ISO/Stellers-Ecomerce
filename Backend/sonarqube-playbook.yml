---
- name: Deploy SonarQube with PostgreSQL
  hosts: localhost
  become: yes
  vars:
    postgres_version: "15"
    postgres_password: "sonar_secure_password"
    sonar_version: "lts-community"
    sonar_db_name: "sonar"
    sonar_db_user: "sonar"
    sonar_db_password: "sonar_secure_password"
    
  tasks:
    - name: Update system parameters for SonarQube
      sysctl:
        name: "{{ item.name }}"
        value: "{{ item.value }}"
        state: present
        reload: yes
      loop:
        - { name: 'vm.max_map_count', value: '524288' }
        - { name: 'fs.file-max', value: '131072' }

    - name: Set ulimit for current session
      shell: |
        ulimit -n 131072
        ulimit -u 8192
      ignore_errors: yes

    - name: Create Docker network for SonarQube
      docker_network:
        name: sonarqube-network
        state: present

    - name: Create PostgreSQL volume
      docker_volume:
        name: postgresql_data
        state: present

    - name: Create SonarQube data volume
      docker_volume:
        name: sonarqube_data
        state: present

    - name: Create SonarQube extensions volume
      docker_volume:
        name: sonarqube_extensions
        state: present

    - name: Create SonarQube logs volume
      docker_volume:
        name: sonarqube_logs
        state: present

    - name: Deploy PostgreSQL container
      docker_container:
        name: sonarqube-postgres
        image: "postgres:{{ postgres_version }}"
        state: started
        restart_policy: always
        networks:
          - name: sonarqube-network
        env:
          POSTGRES_USER: "{{ sonar_db_user }}"
          POSTGRES_PASSWORD: "{{ sonar_db_password }}"
          POSTGRES_DB: "{{ sonar_db_name }}"
        volumes:
          - postgresql_data:/var/lib/postgresql/data
        healthcheck:
          test: ["CMD-SHELL", "pg_isready -U {{ sonar_db_user }}"]
          interval: 10s
          timeout: 5s
          retries: 5

    - name: Wait for PostgreSQL to be ready
      wait_for:
        timeout: 30
      delegate_to: localhost

    - name: Deploy SonarQube container
      docker_container:
        name: sonarqube
        image: "sonarqube:{{ sonar_version }}"
        state: started
        restart_policy: always
        networks:
          - name: sonarqube-network
        ports:
          - "9000:9000"
        env:
          SONAR_JDBC_URL: "jdbc:postgresql://sonarqube-postgres:5432/{{ sonar_db_name }}"
          SONAR_JDBC_USERNAME: "{{ sonar_db_user }}"
          SONAR_JDBC_PASSWORD: "{{ sonar_db_password }}"
        volumes:
          - sonarqube_data:/opt/sonarqube/data
          - sonarqube_extensions:/opt/sonarqube/extensions
          - sonarqube_logs:/opt/sonarqube/logs
        healthcheck:
          test: ["CMD-SHELL", "wget -qO- http://localhost:9000/api/system/status | grep -q UP"]
          interval: 30s
          timeout: 10s
          retries: 10
          start_period: 120s

    - name: Display SonarQube access information
      debug:
        msg:
          - "SonarQube is being deployed!"
          - "Access URL: http://10.27.5.153:9000"
          - "Default credentials:"
          - "  Username: admin"
          - "  Password: admin"
          - "Please wait 2-3 minutes for SonarQube to fully start"
          - "You will be prompted to change the password on first login"
